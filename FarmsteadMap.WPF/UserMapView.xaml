<UserControl x:Class="FarmsteadMap.WPF.UserMapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:FarmsteadMap.WPF"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1400"
             Background="#E0E0E0" 
             Focusable="True"
             KeyDown="UserControl_KeyDown">

    <UserControl.InputBindings>
        <KeyBinding Key="Z" Modifiers="Control" Command="{Binding UndoCommand}" />
        <KeyBinding Key="Z" Modifiers="Control+Shift" Command="{Binding RedoCommand}" />
        <KeyBinding Key="Delete" Command="{Binding DeleteCommand}" />
    </UserControl.InputBindings>

    <UserControl.Resources>
        <DrawingBrush x:Key="GrassTexture" Viewport="0,0,40,40" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing Brush="#F1F8E9">
                    <GeometryDrawing.Geometry>
                        <GeometryGroup>
                            <RectangleGeometry Rect="0,0,40,40"/>
                            <PathGeometry Figures="M 5,35 L 10,25 L 15,35 M 25,15 L 30,5 L 35,15" />
                        </GeometryGroup>
                    </GeometryDrawing.Geometry>
                    <GeometryDrawing.Pen>
                        <Pen Brush="#81C784" Thickness="1.5" StartLineCap="Round" EndLineCap="Round"/>
                    </GeometryDrawing.Pen>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <DrawingBrush x:Key="WaterTexture" Viewport="0,0,40,40" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing Brush="#E1F5FE">
                    <GeometryDrawing.Geometry>
                        <GeometryGroup>
                            <RectangleGeometry Rect="0,0,40,40"/>
                            <PathGeometry Figures="M 0,20 Q 10,10 20,20 T 40,20" />
                        </GeometryGroup>
                    </GeometryDrawing.Geometry>
                    <GeometryDrawing.Pen>
                        <Pen Brush="#29B6F6" Thickness="1.5"/>
                    </GeometryDrawing.Pen>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <DrawingBrush x:Key="SoilTexture" Viewport="0,0,20,20" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing Brush="#D7CCC8">
                    <GeometryDrawing.Geometry>
                        <GeometryGroup>
                            <RectangleGeometry Rect="0,0,20,20"/>
                            <LineGeometry StartPoint="0,0" EndPoint="0,20"/>
                            <LineGeometry StartPoint="10,0" EndPoint="10,20"/>
                        </GeometryGroup>
                    </GeometryDrawing.Geometry>
                    <GeometryDrawing.Pen>
                        <Pen Brush="#8D6E63" Thickness="1"/>
                    </GeometryDrawing.Pen>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <DrawingBrush x:Key="PathTexture" Viewport="0,0,20,20" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing Brush="#F5F5F5">
                    <GeometryDrawing.Geometry>
                        <GeometryGroup>
                            <RectangleGeometry Rect="0,0,20,20"/>
                            <EllipseGeometry Center="10,10" RadiusX="1" RadiusY="1"/>
                        </GeometryGroup>
                    </GeometryDrawing.Geometry>
                    <GeometryDrawing.Pen>
                        <Pen Brush="#BDBDBD" Thickness="1"/>
                    </GeometryDrawing.Pen>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <DrawingBrush x:Key="BuildingTexture" Viewport="0,0,10,10" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing Brush="#CFD8DC">
                    <GeometryDrawing.Geometry>
                        <GeometryGroup>
                            <RectangleGeometry Rect="0,0,10,10"/>
                            <LineGeometry StartPoint="0,0" EndPoint="10,10"/>
                        </GeometryGroup>
                    </GeometryDrawing.Geometry>
                    <GeometryDrawing.Pen>
                        <Pen Brush="#78909C" Thickness="1"/>
                    </GeometryDrawing.Pen>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <Style x:Key="ToolButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="42"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#DDD"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="6">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#E3F2FD"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="#2196F3"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TextureButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="60"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd" Background="{TemplateBinding Background}" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8" Padding="5">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#FAFAFA"/>
                                <Setter TargetName="bd" Property="BorderBrush" Value="#4CAF50"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ModalOverlay" TargetType="Border">
            <Setter Property="Background" Value="#7F000000"/>
            <Setter Property="Visibility" Value="Collapsed"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="70"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="#F9F9F9" BorderBrush="#CCC" BorderThickness="0,0,1,0" Panel.ZIndex="100">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="0,15,0,15" HorizontalAlignment="Center">
                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Назад" Click="BackButton_Click">
                        <Path Data="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" Fill="#555" Stretch="Uniform" Width="16" Height="16"/>
                    </Button>
                    <Separator Margin="10,10" Background="#DDD"/>

                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Вибір (S)" Click="ToolButton_Click" Tag="Select">
                        <Path Data="M7,2L17,12L12,13L16,21L13,22L9,14L4,19V2Z" Fill="#333" Stretch="Uniform" Width="14" Height="14"/>
                    </Button>
                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Рука (H)" Click="ToolButton_Click" Tag="Pan">
                        <Path Data="M18,11H13V6H11V11H6V13H11V18H13V13H18V11Z M21,11V13H19.9C19.6,15.7 17.7,17.9 15,18.7V21H13V18.9C12.3,18.9 11.7,18.9 11,18.9V21H9V18.7C6.3,17.9 4.4,15.7 4.1,13H3V11H4.1C4.4,8.3 6.3,6.1 9,5.3V3H11V5.1C11.7,5.1 12.3,5.1 13,5.1V3H15V5.3C17.7,6.1 19.6,8.3 19.9,11H21Z" Fill="#555" Stretch="Uniform" Width="18" Height="18"/>
                    </Button>
                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Лінійка" Click="ToolButton_Click" Tag="Ruler">
                        <Path Data="M17,2 L22,7 L7,22 L2,17 L17,2 M18,5 L19.5,6.5 M15,8 L16.5,9.5 M12,11 L13.5,12.5 M9,14 L10.5,15.5 M6,17 L7.5,18.5" Fill="#555" Stretch="Uniform" Width="16" Height="16"/>
                    </Button>

                    <Separator Margin="10,10" Background="#DDD"/>

                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Ландшафт" Click="CategoryButton_Click" Tag="Landscape">
                        <Grid>
                            <Rectangle Width="20" Height="20" Fill="{StaticResource GrassTexture}" Stroke="#888" StrokeThickness="1" RadiusX="2" RadiusY="2"/>
                        </Grid>
                    </Button>
                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Будівлі" Click="CategoryButton_Click" Tag="Buildings">
                        <Grid>
                            <Rectangle Width="20" Height="20" Fill="{StaticResource BuildingTexture}" Stroke="#888" StrokeThickness="1" RadiusX="2" RadiusY="2"/>
                        </Grid>
                    </Button>
                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Рослини" Click="CategoryButton_Click" Tag="Vegetation">
                        <Path Data="M12,22C12,22 4,16 4,10C4,6.5 6.5,4 9.5,4C11.5,4 12,5 12,5C12,5 12.5,4 14.5,4C17.5,4 20,6.5 20,10C20,16 12,22 12,22Z" Fill="#4CAF50" Stretch="Uniform" Width="22" Height="22"/>
                    </Button>

                    <Separator Margin="10,10" Background="#DDD"/>

                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Скасувати (Ctrl+Z)" Click="UndoButton_Click">
                        <Path Data="M12.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z" Fill="#555" Stretch="Uniform" Width="16" Height="16"/>
                    </Button>
                    <Button Style="{StaticResource ToolButtonStyle}" ToolTip="Повернути (Ctrl+Shift+Z)" Click="RedoButton_Click">
                        <Path Data="M18.4,10.6C16.55,9 14.15,8 11.5,8C6.85,8 2.92,11.03 1.54,15.22L3.9,16C4.95,12.81 7.95,10.5 11.5,10.5C13.45,10.5 15.23,11.22 16.62,12.38L13,16H22V7L18.4,10.6Z" Fill="#555" Stretch="Uniform" Width="16" Height="16"/>
                    </Button>
                    <Button x:Name="SaveButton" Style="{StaticResource ToolButtonStyle}" ToolTip="Зберегти" Click="SaveButton_Click" Background="#E8F5E9">
                        <Path Data="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" Fill="#2E7D32" Stretch="Uniform" Width="18" Height="18"/>
                    </Button>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <Border x:Name="SideDrawer" Grid.Column="1" Width="280" Background="#FDFDFD" BorderBrush="#DDD" BorderThickness="0,0,1,0" Visibility="Collapsed">
            <Border.Effect>
                <DropShadowEffect Color="#000" BlurRadius="10" ShadowDepth="2" Opacity="0.1" Direction="0"/>
            </Border.Effect>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Border Grid.Row="0" Background="White" Padding="15" BorderBrush="#EEE" BorderThickness="0,0,0,1">
                    <Grid>
                        <TextBlock x:Name="DrawerTitle" Text="Інструменти" FontWeight="SemiBold" FontSize="16" Foreground="#333" VerticalAlignment="Center"/>
                        <Button Content="✕" HorizontalAlignment="Right" Background="Transparent" BorderThickness="0" Click="CloseDrawer_Click" Cursor="Hand" Foreground="#999" FontSize="14"/>
                    </Grid>
                </Border>
                <ScrollViewer Grid.Row="1" Padding="10">
                    <StackPanel x:Name="DrawerContent"/>
                </ScrollViewer>
            </Grid>
        </Border>

        <Grid x:Name="ViewportContainer" Grid.Column="2" Background="#D0D0D0" ClipToBounds="True">

            <ScrollViewer x:Name="EditorScrollViewer" 
                          HorizontalScrollBarVisibility="Auto" 
                          VerticalScrollBarVisibility="Auto"
                          PanningMode="None"
                          PreviewMouseWheel="EditorScrollViewer_PreviewMouseWheel">

                <Canvas x:Name="MainViewport" Width="3000" Height="2000" HorizontalAlignment="Center" VerticalAlignment="Center" Background="White"
                        PreviewMouseDown="Canvas_PreviewMouseDown"
                        PreviewMouseMove="Canvas_PreviewMouseMove"
                        PreviewMouseUp="Canvas_PreviewMouseUp">

                    <Canvas.LayoutTransform>
                        <ScaleTransform x:Name="CanvasScaleTransform"/>
                    </Canvas.LayoutTransform>

                    <Canvas x:Name="GridCanvas" Width="3000" Height="2000" IsHitTestVisible="False">
                        <Canvas.Background>
                            <DrawingBrush Viewport="0,0,50,50" ViewportUnits="Absolute" TileMode="Tile">
                                <DrawingBrush.Drawing>
                                    <GeometryDrawing>
                                        <GeometryDrawing.Geometry>
                                            <GeometryGroup>
                                                <RectangleGeometry Rect="0,0,50,50"/>
                                                <LineGeometry StartPoint="0,0" EndPoint="50,0"/>
                                                <LineGeometry StartPoint="0,0" EndPoint="0,50"/>
                                            </GeometryGroup>
                                        </GeometryDrawing.Geometry>
                                        <GeometryDrawing.Pen>
                                            <Pen Brush="#F5F5F5" Thickness="1"/>
                                        </GeometryDrawing.Pen>
                                    </GeometryDrawing>
                                </DrawingBrush.Drawing>
                            </DrawingBrush>
                        </Canvas.Background>
                    </Canvas>

                    <Canvas x:Name="LandscapeCanvas" Width="3000" Height="2000"/>
                    <Canvas x:Name="BuildingsCanvas" Width="3000" Height="2000"/>
                    <Canvas x:Name="ObjectCanvas" Width="3000" Height="2000"/>
                    <Canvas x:Name="ToolCanvas" Width="3000" Height="2000" IsHitTestVisible="False"/>
                </Canvas>
            </ScrollViewer>

            <Border VerticalAlignment="Bottom" Background="#F9F9F9" BorderBrush="#CCC" BorderThickness="0,1,0,0" Padding="15,8" HorizontalAlignment="Stretch" Opacity="0.95">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <TextBlock x:Name="CoordinatesText" Text="X: 0.00 m, Y: 0.00 m" Foreground="#555" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <Border x:Name="SnappingIndicator" Background="#4CAF50" CornerRadius="3" Padding="6,2" Margin="15,0,0,0" Visibility="Collapsed">
                            <TextBlock Text="SNAP ON" FontSize="10" FontWeight="Bold" Foreground="White"/>
                        </Border>
                    </StackPanel>

                    <StackPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock x:Name="ScaleBarLabel" Text="1 м" Foreground="#666" FontSize="10" HorizontalAlignment="Center" Margin="0,0,0,2"/>
                        <Rectangle x:Name="ScaleBar" Height="4" Fill="#333" Width="50" HorizontalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <Button Content="-" Width="28" Height="28" Click="ZoomOutButton_Click" Background="White" BorderBrush="#DDD" BorderThickness="1" Style="{StaticResource ToolButtonStyle}"/>
                        <TextBlock x:Name="ZoomLevelText" Text="100%" Foreground="#333" VerticalAlignment="Center" Margin="10,0" Width="35" TextAlignment="Center" FontWeight="Bold"/>
                        <Button Content="+" Width="28" Height="28" Click="ZoomInButton_Click" Background="White" BorderBrush="#DDD" BorderThickness="1" Style="{StaticResource ToolButtonStyle}" Margin="0"/>
                    </StackPanel>
                </Grid>
            </Border>

            <Border x:Name="SelectionBox" BorderBrush="#00BCD4" BorderThickness="1.5" Background="#3300BCD4" Visibility="Collapsed" IsHitTestVisible="False" HorizontalAlignment="Left" VerticalAlignment="Top"/>

            <Border x:Name="CompatibilityWarning" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,20,0,0" 
                    Background="#EEF44336" CornerRadius="20" Padding="20,10" Visibility="Collapsed" IsHitTestVisible="False">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="⚠️" Margin="0,0,8,0" Foreground="White"/>
                    <TextBlock Text="Занадто близько!" Foreground="White" FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </Grid>

        <Border x:Name="BuildingModal" Grid.ColumnSpan="3" Style="{StaticResource ModalOverlay}">
            <Border Background="White" Width="320" CornerRadius="10" Padding="25" VerticalAlignment="Center" HorizontalAlignment="Center">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" Opacity="0.4" ShadowDepth="5"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock Text="Нова будівля" FontWeight="Bold" FontSize="20" Margin="0,0,0,20" Foreground="#333"/>

                    <TextBlock Text="Назва:" Foreground="#666" Margin="0,0,0,5"/>
                    <TextBox x:Name="BuildingNameInput" Margin="0,0,0,15" Padding="5" BorderBrush="#DDD"/>

                    <TextBlock Text="Площа / Висота (м):" Foreground="#666" Margin="0,0,0,5"/>
                    <TextBox x:Name="BuildingHeightInput" Text="3.0" Margin="0,0,0,20" Padding="5" BorderBrush="#DDD"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Скасувати" Click="CancelBuilding_Click" Margin="0,0,10,0" Padding="15,8" Background="Transparent" BorderThickness="0" Foreground="#666" Cursor="Hand"/>
                        <Button Content="Створити" Click="SaveBuilding_Click" Padding="20,8" Background="#2C3E50" Foreground="White" BorderThickness="0" FontWeight="Bold" Cursor="Hand">
                            <Button.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="5"/>
                                </Style>
                            </Button.Resources>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
        <Border x:Name="PlantSortModal" Grid.ColumnSpan="3" Style="{StaticResource ModalOverlay}">
            <Border Background="White" Width="320" CornerRadius="10" Padding="25" VerticalAlignment="Center" HorizontalAlignment="Center">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" Opacity="0.4" ShadowDepth="5"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock x:Name="PlantSortTitle" Text="Оберіть сорт" FontWeight="Bold" FontSize="20" Margin="0,0,0,20" Foreground="#333"/>

                    <TextBlock Text="Доступні сорти:" Foreground="#666" Margin="0,0,0,5"/>
                    <ComboBox x:Name="PlantSortComboBox" DisplayMemberPath="Name" Margin="0,0,0,20" Padding="5" Height="35" BorderBrush="#DDD" Background="White"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Скасувати" Click="CancelPlantSort_Click" Margin="0,0,10,0" Padding="15,8" Background="Transparent" BorderThickness="0" Foreground="#666" Cursor="Hand"/>
                        <Button Content="Додати" Click="SavePlantSort_Click" Padding="20,8" Background="#4CAF50" Foreground="White" BorderThickness="0" FontWeight="Bold" Cursor="Hand">
                            <Button.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="5"/>
                                </Style>
                            </Button.Resources>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
